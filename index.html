<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta property="og:image" content="https://i.ibb.co/1Qf3kqZ/invitea-logo.png">
  <title>Panel — Contactos Invitea</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    /* (Estilos idénticos a la versión responsive anterior; por brevedad no los repito en comentarios) */
    :root{
      --azul: #2D68F8;
      --azul-2: #4C8BFF;
      --amarillo: #FFC940;
      --amarillo-2: #FFD96A;
      --bg: #F7F9FB;
      --card-bg: #FFFFFF;
      --text: #0F1724;
      --muted: #6B7280;
      --radius: 10px;
      --shadow-1: 0 5px 14px rgba(17,24,39,0.05);
      --shadow-2: 0 12px 28px rgba(17,24,39,0.06);
      --maxw: 980px;
      --danger: #EF4444;
      --gap: 8px;
      --tooltip-bg: rgba(12,15,20,0.95);
      --tooltip-fg: #ffffff;

      /* sizes */
      --avatar-size: 48px;
      --touch-size: 44px;
      --container-padding: 18px;
    }
    *{box-sizing:border-box}
    html, body { height: 100%; }
    body{
      margin:0;
      font-family:Inter, Montserrat, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background: linear-gradient(180deg, #ffffff 0%, var(--bg) 100%);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      -webkit-tap-highlight-color: transparent;
      font-size:15px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    .container{max-width:var(--maxw);margin:16px auto;padding:var(--container-padding);flex:1 0 auto;width: calc(100% - 32px);}
    header.app-header{display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap;}
    .brand-img { width:56px;height:40px;border-radius:9px;overflow:hidden;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow-2);background:linear-gradient(90deg,var(--azul),var(--azul-2));flex-shrink:0;}
    .brand-img img { width:100%; height:100%; object-fit:contain; display:block; }
    h1{font-size:18px;margin:0;color:var(--text);letter-spacing:0.2px}
    .subtitle{color:var(--muted);font-size:13px}
    .controls{display:flex;gap:10px;margin:10px 0 12px 0;flex-wrap:wrap;align-items:center;}
    .search{flex:1;min-width:140px;background:var(--card-bg);border:1px solid rgba(15,23,36,0.06);padding:10px 12px;border-radius:12px;color:var(--text);outline:none;box-shadow:var(--shadow-1);font-size:14px;}
    .btn{background: linear-gradient(90deg,var(--amarillo), var(--amarillo-2));color: #0A0A0A;border:none;padding:10px 12px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 10px 24px rgba(45,104,248,0.06);display:inline-flex;align-items:center;gap:8px;transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;will-change: transform;font-size:14px;line-height:1;min-height:var(--touch-size);}
    .btn:hover, .btn:focus { transform: translateY(-1.5px); box-shadow: 0 14px 32px rgba(45,104,248,0.07); }
    .btn.ghost{background:transparent;border:1px solid rgba(45,104,248,0.12);color:var(--azul);box-shadow:none;font-weight:700;border-radius:12px;padding:8px 12px;font-size:14px;}
    .btn.row { padding:8px 10px;border-radius:10px;font-size:13px;font-weight:700;box-shadow:none;height:40px;display:inline-flex;align-items:center;gap:8px; }
    .btn.row.mark { background:#fff;color:var(--azul);border:1px solid rgba(45,104,248,0.10); }
    .btn.row.danger { background:transparent;color:var(--danger);border:1px solid rgba(239,68,68,0.10); }
    .stats{display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap}
    .stat{background:var(--card-bg);padding:10px;border-radius:10px;min-width:140px;box-shadow:var(--shadow-1);border:1px solid rgba(15,23,36,0.03);font-size:13px;}
    .stat .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    .stat .value{font-size:15px;font-weight:400;color:var(--azul)}
    .list-card{ background:transparent;border-radius:10px;padding:0;border:0; }
    .list-header{ padding:10px 14px;border-bottom:1px solid rgba(15,23,36,0.04); display:flex;align-items:center;gap:10px;background:linear-gradient(90deg, rgba(45,104,248,0.03), rgba(76,139,255,0.01)); border-radius:10px 10px 0 0; flex-wrap:wrap; }
    .list-header h2{margin:0;font-size:15px;color:var(--azul);font-weight:700}
    .list-header .meta-note{margin-left:auto;color:var(--muted);font-size:12px}
    #listBody{ padding:8px;max-height:60vh;overflow:auto;background:var(--card-bg);border-radius:0 0 10px 10px;border:1px solid rgba(15,23,36,0.03);box-shadow:var(--shadow-1); }
    .row-item{ display:grid; grid-template-columns: var(--avatar-size) 1fr 220px; gap: 12px; align-items:center; padding:12px;border-radius:10px;margin-bottom:8px; background:linear-gradient(180deg, #FFF, #FCFDFF); border:1px solid rgba(15,23,36,0.03); box-shadow: 0 4px 10px rgba(17,24,39,0.02); transition: transform .10s ease, box-shadow .10s ease; will-change: transform; font-size:14px; cursor: pointer; }
    .row-item:hover, .row-item:focus-within { transform: translateY(-2px); box-shadow: var(--shadow-2); }
    .avatar{ width:var(--avatar-size);height:var(--avatar-size);border-radius:10px;background:linear-gradient(90deg,var(--azul),var(--azul-2));display:flex;align-items:center;justify-content:center;color:white;flex-shrink:0;box-shadow:var(--shadow-1);font-size:15px;font-weight:700; }
    .meta{min-width:0}
    .meta .name{font-weight:700;color:var(--text);margin-bottom:8px;font-size:15px}
    .meta .meta-lines{font-size:13px;color:var(--muted);line-height:1.35}
    .meta .meta-lines .label{display:inline-block;color:var(--muted);font-weight:600;width:76px}
    .meta .meta-lines .value{display:inline-block;color:var(--text);font-weight:400;margin-left:6px}
    .actions{ display:flex;align-items:center;gap:10px;min-width:180px;justify-self:end;justify-content:flex-end; }
    .badges{display:flex;gap:8px;align-items:center;flex-shrink:0}
    .badge{ font-size:12px;padding:6px 10px;border-radius:999px;font-weight:500;border:1px solid rgba(0,0,0,0.04); display:inline-flex;align-items:center;gap:8px; }
    .badge.plan{background:linear-gradient(90deg,var(--amarillo), var(--amarillo-2));color:#0A0A0A;border:1px solid rgba(0,0,0,0.04)}
    .badge.status.processed{background:linear-gradient(180deg,#F8FFFB,#EEFFF6);color:var(--azul);border:1px solid rgba(45,104,248,0.05)}
    .badge.status.pending{background:linear-gradient(180deg,#FFF6F6,#FFF0F0);color:var(--danger);border:1px solid rgba(239,68,68,0.06)}
    .action-buttons{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .pagination{display:flex;gap:8px;align-items:center;justify-content:center;padding:10px}
    .empty{padding:16px;text-align:center;color:var(--muted);font-style:italic}
    footer{ padding:12px 14px;text-align:center;color:var(--muted);font-size:13px;margin-top:0;flex-shrink:0;border-top:1px solid rgba(15,23,36,0.03);background:transparent }
    #versionInfo{display:block;margin-top:6px;color:var(--muted);font-size:13px}
    .icon{width:16px;height:16px;display:inline-block;vertical-align:middle}
    .__ia-tooltip { position: fixed; z-index: 9999; background: var(--tooltip-bg); color: var(--tooltip-fg); padding: 8px 10px; border-radius: 8px; font-size: 13px; line-height: 1; pointer-events: none; opacity: 0; transform: translateY(6px) scale(.98); transition: opacity .12s ease, transform .12s ease; box-shadow: 0 6px 20px rgba(2,6,23,0.45); max-width: 72vw; white-space: nowrap; visibility: hidden; }
    .__ia-tooltip.show { opacity: 1; transform: translateY(0) scale(1); visibility: visible; }
    .__ia-tooltip::after { content: ""; position: absolute; left: 50%; transform: translateX(-50%); bottom: -6px; width: 10px; height: 10px; background: var(--tooltip-bg); transform-origin: center; transform: translateX(-50%) rotate(45deg); box-shadow: 0 6px 20px rgba(2,6,23,0.08); }
    .small-btn{ background:transparent;border:1px solid rgba(15,23,36,0.06);padding:8px 10px;border-radius:10px;cursor:pointer;font-size:13px;min-height:var(--touch-size); }
    .small-btn:disabled{opacity:0.5;cursor:not-allowed}
    @media (max-width:1000px){ :root { --maxw: 760px; --avatar-size:44px; --touch-size:44px; } .row-item { grid-template-columns: var(--avatar-size) 1fr 180px; padding:10px; } .brand-img { width:52px; height:36px; } }
    @media (max-width:720px){ :root { --container-padding: 12px; --avatar-size:40px; --touch-size:48px; } .container { margin:12px auto; padding:12px; } header.app-header { gap:10px; align-items:flex-start; } h1 { font-size:16px; } .controls { flex-direction: column; align-items:stretch; } .list-header { padding:10px; gap:8px; align-items:center; } #listBody { max-height: calc(100vh - 320px); } .row-item{ grid-template-columns: var(--avatar-size) 1fr; grid-template-rows: auto auto; gap:8px; padding:10px; } .actions{ grid-column: 1 / -1; justify-content: space-between; width:100%; align-items:center; padding-top:6px; } .action-buttons{ order:2; gap:8px; } .badges{ order:1; gap:6px; flex-wrap:wrap; } .badge { font-size:13px; padding:6px 8px; } .meta .meta-lines .label { width: 86px; font-size:13px; } .meta .meta-lines { font-size:13px; } .btn, .small-btn { font-size:15px; padding:10px 12px; min-height:48px; border-radius:10px; } .search { padding:12px; font-size:15px; } footer { font-size:13px; padding:12px; } .__ia-tooltip { display:none; } }
    @media (max-width:380px){ :root { --avatar-size:36px; } .meta .meta-lines .label { width: 72px; font-size:12px; display:block; } .meta .meta-lines .value { margin-left:0; display:block; font-size:13px; margin-top:4px; } }
    /* selection highlight */
    .row-item.selected { outline: 2px solid rgba(45,104,248,0.14); box-shadow: 0 8px 28px rgba(45,104,248,0.06); }
  </style>
</head>
<body>
  <div class="container" role="main">
    <header class="app-header" role="banner">
      <div class="brand-img" aria-hidden="false">
        <img src="https://i.ibb.co/1Qf3kqZ/invitea-logo.png" alt="Invitea logo">
      </div>
      <div style="min-width:0">
        <h1>Panel de Contactos — Invitea</h1>
        <div class="subtitle">Gestiona solicitudes de personalización y mensajes</div>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button class="btn ghost" id="refreshBtn" type="button" data-tooltip="Recargar la lista" aria-label="Actualizar lista">Actualizar</button>
        <button class="btn" id="exportCsv" type="button" data-tooltip="Descargar solicitudes en CSV" aria-label="Exportar CSV">Exportar CSV</button>
      </div>
    </header>

    <section class="controls" aria-label="Controles">
      <input id="search" class="search" type="search" placeholder="Buscar por nombre o correo..." aria-label="Buscar solicitudes" />
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <div class="pill" id="totalCount" style="background:transparent;border:none;color:var(--muted)">— solicitudes</div>
        <div class="pill" id="pendingCount" style="background:transparent;border:none;color:var(--muted)">— sin procesar</div>
      </div>
    </section>

    <section class="stats" aria-label="Estadísticas">
      <div class="stat"><div class="label">Solicitudes totales (página)</div><div class="value" id="pageTotal">0</div></div>
      <div class="stat"><div class="label">Última actualización</div><div class="value" id="lastUpdate">—</div></div>
      <div class="stat"><div class="label">Con plan seleccionado (página)</div><div class="value" id="withPlan">0</div></div>
    </section>

    <section class="list-card" aria-labelledby="listTitle">
      <div class="list-header">
        <h2 id="listTitle">Solicitudes recientes</h2>
        <div class="meta-note">Más reciente arriba · vista compacta</div>
      </div>

      <div id="listBody" role="list" aria-live="polite">
        <div class="empty" id="loading">Cargando…</div>
      </div>

      <div class="pagination" aria-label="Paginación">
        <button id="prev" class="small-btn" disabled type="button" data-tooltip="Página anterior" aria-label="Página anterior">Anterior</button>
        <div style="color:var(--muted);font-size:13px">Página <span id="pageNumber">1</span></div>
        <button id="next" class="small-btn" disabled type="button" data-tooltip="Página siguiente" aria-label="Página siguiente">Siguiente</button>
      </div>
    </section>

  </div>

  <footer>
    Invitea · Panel de administración
    <span id="versionInfo" aria-live="polite" aria-atomic="true">Publicado: —</span>
  </footer>

  <div id="__ia-tooltip" class="__ia-tooltip" role="status" aria-live="polite" style="display:none"></div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
  import {
    getFirestore, collection, query, orderBy, limit, getDocs,
    startAfter, endBefore, limitToLast, doc, getDoc,
    updateDoc, deleteDoc, where, getCountFromServer, onSnapshot
  } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

  (function(){
    const firebaseConfig = {
      apiKey: "AIzaSyCTh8kPdvu-6Z5_cckNts22VrhdUTLVspM",
      authDomain: "invitea-f7331.firebaseapp.com",
      projectId: "invitea-f7331",
      storageBucket: "invitea-f7331.firebasestorage.app",
      messagingSenderId: "145115727672",
      appId: "1:145115727672:web:d1d89c20bf946b9e2663cd",
      measurementId: "G-8JS1MDZVGQ"
    };

    if (!firebaseConfig || !firebaseConfig.projectId) {
      document.getElementById('listBody').innerHTML = '<div class="empty">Configura firebaseConfig en el HTML para conectar al panel.</div>';
      console.warn('firebaseConfig no configurado.');
      return;
    }

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Page size reducido para compactar vista
    const pageSize = 8;
    let currentPage = 1;
    let firstDocSnap = null;
    let lastDocSnap = null;
    let currentItems = [];

    // unsubcribers for realtime listeners
    let unsubPageListener = null;
    let unsubTotalListener = null;
    let unsubPendingListener = null;

    // UI refs
    const listBody = document.getElementById('listBody');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const pageNumber = document.getElementById('pageNumber');
    const searchInput = document.getElementById('search');
    const exportBtn = document.getElementById('exportCsv');
    const refreshBtn = document.getElementById('refreshBtn');

    const totalCount = document.getElementById('totalCount');
    const pendingCount = document.getElementById('pendingCount');
    const pageTotal = document.getElementById('pageTotal');
    const lastUpdate = document.getElementById('lastUpdate');
    const withPlan = document.getElementById('withPlan');
    const versionInfo = document.getElementById('versionInfo');

    const tooltip = document.getElementById('__ia-tooltip');

    function fmtTimestamp(ts){
      if(!ts) return '—';
      try{
        const d = (ts && typeof ts.toDate === 'function') ? ts.toDate() : new Date(ts || Date.now());
        if(isNaN(d)) return '—';
        return d.toLocaleString('es-MX', { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' });
      } catch(e){ return '—'; }
    }
    function fmtDateShort(ts){
      if(!ts) return '—';
      try{
        const d = (ts && typeof ts.toDate === 'function') ? ts.toDate() : new Date(ts);
        if(isNaN(d)) return '—';
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const yyyy = d.getFullYear();
        return `${dd}/${mm}/${yyyy}`;
      } catch(e){ return '—'; }
    }
    function initials(name){
      if(!name) return 'U';
      return name.trim().split(/\s+/).map(s => s[0] || '').slice(0,2).join('').toUpperCase();
    }

    document.querySelectorAll('button').forEach(btn => {
      if (!btn.hasAttribute('type')) btn.setAttribute('type','button');
      if(btn.dataset && btn.dataset.tooltip && !btn.hasAttribute('title')) btn.setAttribute('title', btn.dataset.tooltip);
    });

    let tooltipVisible = false;
    let tooltipHideTimer = null;
    function showTooltipFor(target){
      const text = target.getAttribute('data-tooltip') || target.getAttribute('title') || '';
      if(!text) return hideTooltip();
      // hide tooltips on small screens (touch-first)
      if(window.matchMedia && window.matchMedia('(max-width:720px)').matches) return;
      tooltip.textContent = text;
      tooltip.style.display = 'block';
      tooltip.style.visibility = 'hidden';
      tooltip.classList.remove('show');
      requestAnimationFrame(() => {
        const rect = target.getBoundingClientRect();
        const margin = 6;
        const preferAbove = rect.top > 80;
        const tooltipW = tooltip.offsetWidth;
        const tooltipH = tooltip.offsetHeight;
        let top, left;
        if(preferAbove){
          top = window.scrollY + rect.top - tooltipH - margin;
        } else {
          top = window.scrollY + rect.bottom + margin;
        }
        left = window.scrollX + rect.left + (rect.width / 2) - (tooltipW / 2);
        const pad = 6;
        left = Math.max(pad, Math.min(left, window.scrollX + document.documentElement.clientWidth - tooltipW - pad));
        tooltip.style.top = (top) + 'px';
        tooltip.style.left = (left) + 'px';
        tooltip.style.visibility = 'visible';
        requestAnimationFrame(() => tooltip.classList.add('show'));
        tooltipVisible = true;
      });
      clearTimeout(tooltipHideTimer);
    }
    function hideTooltipSoon(delay=100){
      clearTimeout(tooltipHideTimer);
      tooltipHideTimer = setTimeout(() => hideTooltip(), delay);
    }
    function hideTooltip(){
      tooltip.classList.remove('show');
      tooltipVisible = false;
      setTimeout(()=> { if(!tooltipVisible) tooltip.style.display = 'none'; }, 140);
    }
    function attachTooltipHandlers(root=document){
      root.querySelectorAll('[data-tooltip]').forEach(el => {
        if(el.__ia_tooltip_bound) return;
        el.__ia_tooltip_bound = true;
        el.addEventListener('mouseenter', () => showTooltipFor(el));
        el.addEventListener('mouseleave', () => hideTooltipSoon());
        el.addEventListener('focus', () => showTooltipFor(el), true);
        el.addEventListener('blur', () => hideTooltipSoon(), true);
      });
    }

    function normalizePlan(raw){
      if(!raw) return 'Sin plan';
      const s = String(raw).toLowerCase();
      if(s.includes('bas') || s.includes('bás') || s.includes('basico') ) return 'Básico';
      if(s.includes('estan') || s.includes('estandar') || s.includes('estánd') ) return 'Estándar';
      if(s.includes('premium') || s.includes('prem') ) return 'Premium';
      return 'Sin plan';
    }

    // Utility to normalize date fields into a JS Date or null
    function docDate(d){
      if(!d) return null;
      if(d.createdAt && typeof d.createdAt.toDate === 'function') {
        try { return d.createdAt.toDate(); } catch(e){ /* ignore */ }
      }
      if(d.ts && typeof d.ts.toDate === 'function') {
        try { return d.ts.toDate(); } catch(e){ /* ignore */ }
      }
      if(d.date_iso){
        const dt = new Date(d.date_iso);
        if(!isNaN(dt)) return dt;
      }
      return null;
    }

    function createMetaLines(d){
      const container = document.createElement('div');
      container.className = 'meta-lines';
      // Tipo
      const typeLine = document.createElement('div');
      const typeLabel = document.createElement('span'); typeLabel.className = 'label';
      typeLabel.textContent = 'Tipo:';
      const typeValue = document.createElement('span'); typeValue.className = 'value';
      const val = d.type || d.docType || d.documentType || d.document_type || '—';
      typeValue.textContent = val || '—';
      typeLine.appendChild(typeLabel);
      typeLine.appendChild(typeValue);
      // Email
      const emailLine = document.createElement('div');
      const emailLabel = document.createElement('span'); emailLabel.className = 'label';
      emailLabel.textContent = 'Correo:';
      const emailValue = document.createElement('span'); emailValue.className = 'value';
      emailValue.textContent = d.email || '—';
      emailLine.appendChild(emailLabel);
      emailLine.appendChild(emailValue);
      // Phone
      const phoneLine = document.createElement('div');
      const phoneLabel = document.createElement('span'); phoneLabel.className = 'label';
      phoneLabel.textContent = 'Teléfono:';
      const phoneValue = document.createElement('span'); phoneValue.className = 'value';
      phoneValue.textContent = d.phone || '—';
      phoneLine.appendChild(phoneLabel);
      phoneLine.appendChild(phoneValue);
      // Date
      const dateLine = document.createElement('div');
      const dateLabel = document.createElement('span'); dateLabel.className = 'label';
      dateLabel.textContent = 'Fecha:';
      const dateValue = document.createElement('span'); dateValue.className = 'value';
      if(d.date_ddmmyyyy) dateValue.textContent = d.date_ddmmyyyy;
      else if(d.date_iso) {
        try{
          const dt = new Date(d.date_iso);
          if(!isNaN(dt)) dateValue.textContent = fmtDateShort(dt);
          else dateValue.textContent = '—';
        }catch(e){ dateValue.textContent = '—'; }
      } else {
        const dt = docDate(d);
        dateValue.textContent = dt ? fmtDateShort(dt) : fmtDateShort(d.createdAt || d.ts);
      }
      dateLine.appendChild(dateLabel);
      dateLine.appendChild(dateValue);

      container.appendChild(typeLine);
      container.appendChild(emailLine);
      container.appendChild(phoneLine);
      container.appendChild(dateLine);
      return container;
    }

    function createIcon(name){
      const ns = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(ns,'svg');
      svg.setAttribute('class','icon');
      svg.setAttribute('viewBox','0 0 24 24');
      svg.setAttribute('fill','none');
      svg.setAttribute('stroke','currentColor');
      svg.setAttribute('stroke-width','1.6');
      svg.setAttribute('stroke-linecap','round');
      svg.setAttribute('stroke-linejoin','round');
      if(name === 'check'){
        const path = document.createElementNS(ns,'path');
        path.setAttribute('d','M20 6L9 17l-5-5');
        svg.appendChild(path);
      } else if(name === 'trash'){
        const poly = document.createElementNS(ns,'polyline');
        poly.setAttribute('points','3 6 5 6 21 6');
        const p1 = document.createElementNS(ns,'path');
        p1.setAttribute('d','M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6');
        const p2 = document.createElementNS(ns,'path');
        p2.setAttribute('d','M10 11v6');
        const p3 = document.createElementNS(ns,'path');
        p3.setAttribute('d','M14 11v6');
        svg.appendChild(poly);
        svg.appendChild(p1);
        svg.appendChild(p2);
        svg.appendChild(p3);
      }
      return svg;
    }

    function sanitizeForCsv(s){
      if(s == null) return '';
      const str = String(s).replace(/"/g,'""').replace(/\r\n|\r|\n/g, '\\n');
      if(/^[=+\-@]/.test(str)) return `'${str}`;
      return str;
    }

    function setVersionInfo(dateObj, id, title){
      if(!dateObj){
        versionInfo.textContent = 'Publicado: —';
        versionInfo.dataset.pubId = '';
        return;
      }
      try {
        const d = (typeof dateObj.toDate === 'function') ? dateObj.toDate() : new Date(dateObj);
        if(isNaN(d)) { versionInfo.textContent = 'Publicado: —'; versionInfo.dataset.pubId = ''; return; }
        const human = d.toLocaleString('es-MX', { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' });
        const iso = d.toISOString();
        versionInfo.textContent = `Publicado: ${human} · (${iso})`;
        versionInfo.dataset.pubId = id || '';
        versionInfo.title = title ? `Publicación: ${title}` : '';
      } catch(e){
        versionInfo.textContent = 'Publicado: —';
        versionInfo.dataset.pubId = '';
      }
    }

    // ---------- Real-time helpers ----------
    function cleanupPageListener(){
      if(typeof unsubPageListener === 'function'){ unsubPageListener(); unsubPageListener = null; }
    }
    function cleanupCountsListeners(){
      if(typeof unsubTotalListener === 'function'){ unsubTotalListener(); unsubTotalListener = null; }
      if(typeof unsubPendingListener === 'function'){ unsubPendingListener(); unsubPendingListener = null; }
    }

    // Listen to counts in real-time (ATTENCIÓN: escuchar toda la colección puede ser costoso en colecciones grandes)
    function listenCountsRealtime(){
      try {
        const colRef = collection(db, 'contact_requests');
        // total
        cleanupCountsListeners();
        unsubTotalListener = onSnapshot(query(colRef), snap => {
          totalCount.textContent = `${snap.size} solicitudes`;
        }, err => {
          console.warn('Error total count snapshot', err);
        });
        // pending (processed == false)
        unsubPendingListener = onSnapshot(query(colRef, where('processed','==', false)), snap => {
          pendingCount.textContent = `${snap.size} sin procesar`;
        }, err => {
          console.warn('Error pending count snapshot', err);
        });
      } catch(e){
        console.warn('No se pudo iniciar listeners para conteos', e);
      }
    }

    // Listen to a page query in realtime; q must be a Firestore query
    function listenToPageQuery(q){
      cleanupPageListener();
      listBody.innerHTML = '<div class="empty">Cargando…</div>';
      unsubPageListener = onSnapshot(q, snap => {
        const docs = snap.docs;
        const docsArr = docs.map(d => ({ id: d.id, data: d.data(), _snap: d }));
        // update pagination anchors for first/last snapshots
        firstDocSnap = docs[0] || null;
        lastDocSnap = docs[docs.length - 1] || null;
        currentItems = docsArr;
        render(docsArr);
        updatePagination(docs.length === pageSize);
      }, err => {
        console.error('Error listening page', err);
        listBody.innerHTML = '<div class="empty">Error al cargar: ' + (err.message || '') + '</div>';
      });
    }

    // Helper to build page query for given cursor (startAfterDoc may be null)
    function buildPageQuery(startAfterDoc){
      const colRef = collection(db, 'contact_requests');
      if(!startAfterDoc) return query(colRef, orderBy('createdAt','desc'), limit(pageSize));
      return query(colRef, orderBy('createdAt','desc'), startAfter(startAfterDoc), limit(pageSize));
    }

    // ---------- Render function (same lógica que antes) ----------
    function render(items){
      listBody.innerHTML = '';
      if(!items || items.length === 0){
        listBody.innerHTML = '<div class="empty">No hay solicitudes en esta página.</div>';
        pageTotal.textContent = '0';
        withPlan.textContent = '0';
        lastUpdate.textContent = '—';
        setVersionInfo(null);
        return;
      }

      let planCount = 0;
      let latest = null;

      items.forEach(entry => {
        const id = entry.id;
        const d = entry.data;
        if (d.selectedPlan) planCount++;

        const createdDt = docDate(d);
        if(createdDt && (!latest || createdDt > latest)) latest = createdDt;

        const item = document.createElement('div');
        item.className = 'row-item';
        item.setAttribute('role','listitem');
        item.dataset.id = id;
        item.setAttribute('tabindex', '0');
        item.setAttribute('aria-labelledby', `name-${id}`);

        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.textContent = initials(d.name || d.nombre || d.name);

        const meta = document.createElement('div'); meta.className = 'meta';
        const nameEl = document.createElement('div'); nameEl.className = 'name';
        nameEl.id = `name-${id}`;
        nameEl.textContent = d.name || d.nombre || 'Sin nombre';
        const metaLines = createMetaLines(d);
        meta.appendChild(nameEl);
        meta.appendChild(metaLines);

        const actions = document.createElement('div'); actions.className = 'actions';

        const badges = document.createElement('div'); badges.className = 'badges';
        const normalized = normalizePlan(d.selectedPlan);
        const planBadge = document.createElement('div'); planBadge.className = 'badge plan';
        planBadge.textContent = normalized;
        const statusBadge = document.createElement('div'); statusBadge.className = 'badge status ' + (d.processed ? 'processed' : 'pending');
        statusBadge.textContent = d.processed ? 'Procesado' : 'Sin procesar';
        badges.appendChild(planBadge);
        badges.appendChild(statusBadge);

        const actionButtons = document.createElement('div'); actionButtons.className = 'action-buttons';

        const markBtn = document.createElement('button');
        markBtn.className = 'btn row mark';
        markBtn.type = 'button';
        markBtn.setAttribute('data-tooltip', d.processed ? 'Marcar como no procesado' : 'Marcar como procesado');
        markBtn.setAttribute('aria-label', d.processed ? 'Marcar no procesado' : 'Marcar procesado');
        markBtn.setAttribute('aria-pressed', String(!!d.processed));
        markBtn.appendChild(createIcon('check'));
        const markLabel = document.createElement('span');
        markLabel.className = 'mark-label';
        markLabel.textContent = d.processed ? 'No' : 'OK';
        markBtn.appendChild(markLabel);

        function updateMarkBtnUI(isProcessed){
          markBtn.setAttribute('data-tooltip', isProcessed ? 'Marcar como no procesado' : 'Marcar como procesado');
          markBtn.setAttribute('aria-label', isProcessed ? 'Marcar no procesado' : 'Marcar procesado');
          markBtn.setAttribute('aria-pressed', String(!!isProcessed));
          markLabel.textContent = isProcessed ? 'No' : 'OK';
          statusBadge.textContent = isProcessed ? 'Procesado' : 'Sin procesar';
          statusBadge.className = 'badge status ' + (isProcessed ? 'processed' : 'pending');
        }

        markBtn.addEventListener('click', async (ev) => {
          ev.stopPropagation();
          if(markBtn.disabled) return;
          markBtn.disabled = true;
          markBtn.setAttribute('aria-busy', 'true');
          try {
            const ref = doc(db, 'contact_requests', id);
            const snap = await getDoc(ref);
            if(!snap.exists()){
              alert('Registro no encontrado');
              // reload current page listener will pick changes
              return;
            }
            const current = snap.data().processed || false;
            await updateDoc(ref, { processed: !current });
            // no need to call updateGlobalCounts because realtime listeners will update counts
            updateMarkBtnUI(!current);
          } catch(err){
            console.error(err);
            alert('Error actualizando estado');
          } finally { markBtn.removeAttribute('aria-busy'); markBtn.disabled = false; }
        });

        const delBtn = document.createElement('button');
        delBtn.className = 'btn row danger';
        delBtn.type = 'button';
        delBtn.setAttribute('data-tooltip', 'Eliminar esta solicitud');
        delBtn.setAttribute('aria-label', 'Eliminar solicitud');
        delBtn.appendChild(createIcon('trash'));
        delBtn.appendChild(document.createTextNode('Borrar'));

        delBtn.addEventListener('click', async (ev) => {
          ev.stopPropagation();
          if(!confirm('¿Eliminar esta solicitud? Esta acción no se puede deshacer.')) return;
          if(delBtn.disabled) return;
          delBtn.disabled = true;
          try {
            await deleteDoc(doc(db, 'contact_requests', id));
            // listener will remove the item from the UI automatically
          } catch(err){
            console.error(err);
            alert('Error eliminando');
          } finally { delBtn.disabled = false; }
        });

        item.addEventListener('keydown', (e) => {
          if(e.key === 'Enter' || e.key === ' '){
            e.preventDefault();
            markBtn.click();
          } else if((e.key === 'Delete' || e.key === 'Backspace') && e.shiftKey){
            delBtn.click();
          }
        });

        // Selection: update footer versioner on click/focus for accessibility
        item.addEventListener('click', () => {
          setVersionInfo(createdDt, id, d.name || d.nombre || '');
          document.querySelectorAll('.row-item.selected').forEach(r => r.classList.remove('selected'));
          item.classList.add('selected');
        });
        item.addEventListener('focus', () => {
          setVersionInfo(createdDt, id, d.name || d.nombre || '');
        });

        actionButtons.appendChild(markBtn);
        actionButtons.appendChild(delBtn);

        actions.appendChild(badges);
        actions.appendChild(actionButtons);

        item.appendChild(avatar);
        item.appendChild(meta);
        item.appendChild(actions);

        listBody.appendChild(item);
      });

      pageTotal.textContent = String(items.length);
      withPlan.textContent = String(planCount);
      lastUpdate.textContent = latest ? latest.toLocaleString('es-MX', { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' }) : '—';
      currentItems = items;
      attachTooltipHandlers(listBody);

      // initialize footer versioner with the top-most (más reciente) item of the page
      if(items.length && items[0]){
        const firstCreated = docDate(items[0].data) || null;
        setVersionInfo(firstCreated, items[0].id, items[0].data.name || items[0].data.nombre || '');
      } else {
        setVersionInfo(null);
      }
    }

    // ---------- Pagination using realtime listeners ----------
    function updatePagination(hasNext){
      nextBtn.disabled = !hasNext;
      prevBtn.disabled = (currentPage <= 1);
    }

    async function goToFirstPage(){
      currentPage = 1;
      pageNumber.textContent = currentPage;
      const q = buildPageQuery(null);
      listenToPageQuery(q);
    }

    async function goToNextPage(){
      if(!lastDocSnap) return;
      currentPage++;
      pageNumber.textContent = currentPage;
      // build query starting after lastDocSnap of previous listener
      const q = buildPageQuery(lastDocSnap);
      listenToPageQuery(q);
    }

    async function goToPrevPage(){
      // For previous page we need to query endBefore(firstDocSnap) with limitToLast
      // We'll create a snapshot query for prev page; onSnapshot supports limitToLast as well
      const colRef = collection(db, 'contact_requests');
      try {
        currentPage = Math.max(1, currentPage - 1);
        pageNumber.textContent = currentPage;
        cleanupPageListener();
        const q = query(colRef, orderBy('createdAt','desc'), endBefore(firstDocSnap), limitToLast(pageSize));
        listBody.innerHTML = '<div class="empty">Cargando…</div>';
        unsubPageListener = onSnapshot(q, snap => {
          const docs = snap.docs;
          const docsArr = docs.map(d => ({ id: d.id, data: d.data(), _snap: d }));
          firstDocSnap = docs[0] || null;
          lastDocSnap = docs[docs.length - 1] || null;
          currentItems = docsArr;
          render(docsArr);
          updatePagination(true);
        }, err => {
          console.error('Error loading prev page', err);
          listBody.innerHTML = '<div class="empty">Error al cargar: ' + (err.message || '') + '</div>';
        });
      } catch(err){
        console.error('Error goToPrevPage', err);
      }
    }

    prevBtn.addEventListener('click', async () => { prevBtn.disabled = true; await goToPrevPage(); });
    nextBtn.addEventListener('click', async () => { nextBtn.disabled = true; await goToNextPage(); });

    // Export CSV (igual que antes)
    async function exportCSV(){
      try {
        const maxExport = 5000;
        if(!confirm('Exportar hasta ' + maxExport + ' solicitudes como máximo. ¿Continuar?')) return;
        const colRef = collection(db, 'contact_requests');
        const q = query(colRef, orderBy('createdAt','desc'), limit(maxExport));
        const snap = await getDocs(q);
        const rows = snap.docs.map(docSnap => {
          const d = docSnap.data();
          const name = sanitizeForCsv(d.name||d.nombre||'');
          const email = sanitizeForCsv(d.email||'');
          const phone = sanitizeForCsv(d.phone||'');
          const plan = sanitizeForCsv(d.selectedPlan||'');
          const type = sanitizeForCsv((d.type||d.docType||d.documentType||d.document_type)||'');
          const date = sanitizeForCsv(d.date_ddmmyyyy||d.date_iso||'');
          const msg = sanitizeForCsv(d.message||'');
          const processed = d.processed ? 'SI' : 'NO';
          const created = sanitizeForCsv(fmtTimestamp(d.createdAt || d.ts));
          return ['"' + name + '"','"' + email + '"','"' + phone + '"','"' + plan + '"','"' + type + '"','"' + date + '"', processed, '"' + created + '"','"' + msg + '"'].join(',');
        });
        const header = ['Nombre','Email','Teléfono','Plan','TipoDocumento','FechaEvento','Procesado','CreadoEn','Mensaje'];
        const csv = [header.join(','), ...rows].join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'invitea_contact_requests.csv'; a.click(); URL.revokeObjectURL(url);
      } catch(err){ console.error(err); alert('Error exportando'); }
    }

    exportBtn.addEventListener('click', exportCSV);
    refreshBtn.addEventListener('click', async () => { await goToFirstPage(); });

    // Search (client-side for currentItems)
    function searchInPage(q){
      if(!q) { render(currentItems); return; }
      const lower = q.toLowerCase();
      const filtered = currentItems.filter(d => {
        const name = (d.data.name||d.data.nombre||'').toLowerCase();
        const email = (d.data.email||'').toLowerCase();
        return name.includes(lower) || email.includes(lower);
      });
      render(filtered);
    }
    function debounce(fn, wait=200){
      let t;
      return (...args) => { clearTimeout(t); t = setTimeout(()=> fn(...args), wait); };
    }
    searchInput.addEventListener('input', debounce((e) => searchInPage(e.target.value.trim()), 200));

    // Initialize: start listening counts and first page in realtime
    document.addEventListener('DOMContentLoaded', () => {
      listenCountsRealtime(); // real-time counts
      goToFirstPage();        // real-time first page
      attachTooltipHandlers(document);
    });

    // Clean up listeners if the page unloads
    window.addEventListener('beforeunload', () => {
      cleanupPageListener();
      cleanupCountsListeners();
    });

    window.addEventListener('error', (e) => console.error(e));
  })();
  </script>
</body>
</html>
